
import { SPHttpClient, SPHttpClientResponse } from "@microsoft/sp-http";
import { IDisputeTransaction, IExistingDisputeRow } from "../models/IDisputeTransaction";

export class SharePointDisputeService {
  private readonly spHttpClient: SPHttpClient;
  private readonly siteUrl: string;
  private readonly listTitle: string;

  constructor(spHttpClient: SPHttpClient, siteUrl: string, listTitle: string) {
    this.spHttpClient = spHttpClient;
    this.siteUrl = siteUrl.replace(/\/$/, "");
    this.listTitle = listTitle;
  }

  public async getExistingByCivilId(civilId: string): Promise<IExistingDisputeRow[]> {
    const filter = `CivilId eq '${civilId.replace(/'/g, "''")}'`;
    const url =
      `${this.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(this.listTitle)}')/items` +
      `?$select=Id,CivilId,Status,MaskedCardNo,TxnDate,TxnTime,TxnAmount,MerchantName,DisputeReason,Created` +
      `&$filter=${encodeURIComponent(filter)}` +
      `&$orderby=Created desc&$top=50`;

    const resp = await this.spHttpClient.get(url, SPHttpClient.configurations.v1);
    const json = await resp.json();

    const items = (json && json.value) ? json.value : [];
    return items.map((x: any) => ({
      id: x.Id,
      civilId: x.CivilId,
      status: x.Status,
      cardMasked: x.MaskedCardNo,
      txnDate: x.TxnDate,
      txnTime: x.TxnTime,
      txnAmount: x.TxnAmount,
      merchantName: x.MerchantName,
      disputeReason: x.DisputeReason,
      created: x.Created
    }));
  }

  public async addDisputeItem(payload: {
    civilId: string;
    paciRequestId: string;
    cardNo: string;
    maskedCardNo: string;
    txnDate: string;
    txnTime: string;
    txnAmount: number;
    merchantName: string;
    disputeReason: string;
    comment: string;
  }): Promise<number> {
    const url = `${this.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(this.listTitle)}')/items`;

    const body: any = {
      __metadata: { type: "SP.Data.FlowardDisputesListItem" }, // OPTIONAL; can remove if it causes issues
      Title: payload.civilId,
      CivilId: payload.civilId,
      PaciRequestId: payload.paciRequestId,
      CardNo: payload.cardNo,
      MaskedCardNo: payload.maskedCardNo,
      TxnDate: payload.txnDate,
      TxnTime: payload.txnTime,
      TxnAmount: payload.txnAmount,
      MerchantName: payload.merchantName,
      DisputeReason: payload.disputeReason,
      Comment: payload.comment || "",
      Status: "New"
    };

    // Some environments fail with __metadata type. If so, remove __metadata and keep the rest.
    const resp = await this.spHttpClient.post(
      url,
      SPHttpClient.configurations.v1,
      {
        headers: {
          "Accept": "application/json;odata=verbose",
          "Content-Type": "application/json;odata=verbose"
        },
        body: JSON.stringify(body)
      }
    );

    if (!resp.ok) {
      const t = await resp.text();
      throw new Error("SharePoint insert failed: " + t);
    }

    const json = await resp.json();
    const id = json && json.d && json.d.Id ? json.d.Id : 0;
    return id;
  }

  public async addAttachment(itemId: number, file: File): Promise<void> {
    const url =
      `${this.siteUrl}/_api/web/lists/getbytitle('${encodeURIComponent(this.listTitle)}')/items(${itemId})/AttachmentFiles/add(FileName='${encodeURIComponent(file.name)}')`;

    const buffer = await file.arrayBuffer();

    const resp: SPHttpClientResponse = await this.spHttpClient.post(
      url,
      SPHttpClient.configurations.v1,
      {
        headers: {
          "Accept": "application/json;odata=verbose"
        },
        body: buffer as any
      }
    );

    if (!resp.ok) {
      const t = await resp.text();
      throw new Error("Attachment upload failed: " + t);
    }
  }
}