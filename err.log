import * as React from 'react';
import { validateCivilId } from './CustomerValidation';
import { ICustomerInfo, IFlowardCard, IFlowardCustomerResponse } from './ICustomerInfo';

export interface IProps {
  apiBaseUrl: string;
  onCustomerFound: (customer: ICustomerInfo) => void;
  onCustomerNotFound: (message: string) => void;
}

export interface IState {
  civilId: string;
  loading: boolean;
  message?: string;
  customer?: ICustomerInfo;
}

export default class CustomerLookup extends React.Component<IProps, IState> {
  constructor(props: IProps) {
    super(props);
    this.state = {
      civilId: '',
      loading: false
    };
  }

  public render(): React.ReactElement<IProps> {
    const { customer, loading, message } = this.state;

    return (
      <div style={{ padding: 12, maxWidth: 700 }}>
        <h3 style={{ marginTop: 0 }}>Customer Lookup</h3>

        <div style={{ display: 'flex', gap: 8, marginBottom: 10 }}>
          <input
            type='text'
            value={this.state.civilId}
            maxLength={12}
            onChange={(e) => {
              const v: string = (e.target as HTMLInputElement).value;
              if (/^\d*$/.test(v)) {
                this.setState({ civilId: v });
              }
            }}
            placeholder='Enter Civil ID'
            style={{ flex: 1, padding: 8 }}
            disabled={loading}
          />
          <button onClick={() => this.lookup()} disabled={loading} style={{ padding: '8px 14px' }}>
            {loading ? 'Searching...' : 'Search'}
          </button>
        </div>

        {message && <div style={{ marginBottom: 10 }}>{message}</div>}

        {customer && (
          <div style={{ border: '1px solid #ddd', padding: 12, borderRadius: 4 }}>
            <div>
              <b>Civil ID : </b>
              {customer.civilId}
            </div>
            <div>
              <b>Name AR : </b>
              {customer.fullNameAr}
            </div>
            <div>
              <b>Name EN : </b>
              {customer.fullNameEn}
            </div>
            <div>
              <b>Nationality : </b>
              {customer.nationality}
            </div>
            <div>
              <b>DOB : </b>
              {customer.dob}
            </div>
            <div>
              <b>Mobile : </b>
              {customer.mobile}
            </div>
          </div>
        )}
      </div>
    );
  }

  private async lookup(): Promise<void> {
    const civilId: string = (this.state.civilId || '').trim();

    const validationError: string | null = validateCivilId(civilId);
    if (validationError) {
      this.setState({ message: validationError, customer: undefined, loading: false });
      this.props.onCustomerNotFound(validationError);
      return;
    }

    if (!this.props.apiBaseUrl) {
      const msg = 'API Base URL is not configured.';
      this.setState({ message: msg, customer: undefined, loading: false });
      this.props.onCustomerNotFound(msg);
      return;
    }

    this.setState({ loading: true, message: undefined, customer: undefined });

    try {
      const url: string = this.props.apiBaseUrl.replace(/\/$/, '') + '/api/floward/' + encodeURIComponent(civilId);

      const resp: Response = await fetch(url, { method: 'GET', headers: { Accept: 'application/json' } });

      if (resp.status === 404) {
        const txt: string = await resp.text();
        const msg = txt && txt.trim() ? txt : 'Customer not found.';
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      if (!resp.ok) {
        const txt: string = await resp.text();
        const msg = 'Error calling API: ' + txt;
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      const api: IFlowardCustomerResponse = (await resp.json()) as IFlowardCustomerResponse;

      if (!api) {
        const msg = 'Empty response from API.';
        this.setState({ loading: false, message: msg });
        this.props.onCustomerNotFound(msg);
        return;
      }

      if (api.errorCode !== 0) {
        const msg = api.errorDesc || 'Customer not found.';
        this.setState({ loading: false, message: msg });
        this.props.onCustomerNotFound(msg);
        return;
      }

      const c: IFlowardCard = api.cards[0];

      const customer: ICustomerInfo = {
        civilId: c.civilId,
        fullNameAr: c.cardholderNameAr,
        fullNameEn: c.cardholderNameEn,
        nationality: c.nationality,
        dob: c.dateOfBirth,
        mobile: c.cardholderMobile
      };

      this.setState({ loading: false, customer, message: undefined });

      this.props.onCustomerFound(customer);
    } catch (e) {
      const msg = e && (e as any).message ? (e as any).message : 'Unexpected error.';
      this.setState({
        loading: false,
        message: msg
      });
      this.props.onCustomerNotFound(msg);
    }
  }
}
