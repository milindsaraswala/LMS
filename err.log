using Microsoft.SharePoint;
using System;
using System.Configuration;
using System.Net;
using System.Threading.Tasks;
using System.Web.Http;
using webApi.Models.Floward;
using webApi.Models.PACI;
using webApi.Services.Floward;

namespace webApi.Controllers
{
	[RoutePrefix("api/paci")]
	public class PaciAuthController : ApiController
	{
		private readonly IPaciSoapClient _soapClient;
		private readonly IPaciAuthStatusReader _statuReader;

		public PaciAuthController()
		{
			_soapClient = new PaciSoapClient();
			_statuReader = new PaciAuthStatusReader();
		}

		[HttpPost]
		[Route("initiate-auth")]
		public async Task<IHttpActionResult> InitiateAuth(PaciInitiateAuthRequestDto requestDto)
		{
			if (requestDto == null || string.IsNullOrEmpty(requestDto.CivilNo))
				return BadRequest("CivilNo is required");

			try
			{
				var callbackUrl = ConfigurationManager.AppSettings["PaciCallbackUrl"];
				var resp = await _soapClient.InitiateAuthAsync(requestDto);

				if (string.IsNullOrEmpty(resp.RequestId))
				{
					return Content(HttpStatusCode.BadGateway, "No RequestId returned from PACI");
				}

				return Ok(resp);
			}
			catch (Exception ex)
			{
				return Content(HttpStatusCode.InternalServerError,
					new { message = "Error while calling PACI", detail = ex.Message });
			}
		}

		[HttpGet]
		[Route("status/{requestId}")]
		public IHttpActionResult GetStatus(string requestId)
		{
			var status = _statuReader.GetStatus(requestId);

			if(status == null)
			{
				return Ok(new PaciStatusResponseDto
				{
					RequestId=requestId,
					IsProcessed=false
				});
			}
			return Ok(status);
		}

		[HttpGet]
		[Route("ping")]
		public IHttpActionResult Ping()
		{
			return Ok("PACI controller loaded");
		}	
	}
}
