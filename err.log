private submitToSharePoint = async (): Promise<void> => {
    const err = this.validateAll();
    if (err) {
      this.setState({ message: err });
      return;
    }

    if (!this.state.currentCaseId) {
      throw new Error("CaseId is missing. Cannot submit case.");
    }

    const customer = this.state.customer!;
    const paciRequestId = this.state.requestId!;
    const cards = this.state.cards || [];
    const caseId = this.state.currentCaseId;

    const submitted: IExistingDisputeRow[] = [];

    this.setState({ submitting: true, message: "Submitting to SharePoint..." });

    try {
      let caseItemId = this.state.caseItemId;

      if (!caseItemId) {
        caseItemId = await this.caseSvc.createCase({
          caseId: caseId,
          civilId: customer.civilId,
          customerName: customer.fullNameEn,
          mobileNumber: customer.mobile
        });

        const encoded = encodeString(caseItemId.toString());
        const deepLink = `${this.props.siteUrl}/SitePages/Floward.aspx?c=${encoded}`;

        await this.caseSvc.updateCaseDeepLink(caseItemId, encoded, deepLink);
        // this.setState({ caseItemId: caseItemId });
      }

      for (let i = 0; i < this.state.transactions.length; i++) {
        const t = this.state.transactions[i];

        // get masked card
        let masked = "",
          cardExId = "";
        for (let c = 0; c < cards.length; c++) {
          if (cards[c].cardNo === t.cardNo) {
            masked = cards[c].maskedCardNo;
            cardExId = cards[c].cardExid;
            break;
          }
        }

        const itemId = await this.spSvc.addDisputeItem({
          civilId: customer.civilId,
          caseId: caseId,
          paciRequestId: paciRequestId,
          cardNo: t.cardNo!,
          maskedCardNo: masked,
          cardExId: cardExId,
          txnDate: t.txnDate!,
          txnTime: t.txnTime!,
          txnAmount: Number(t.txnAmount),
          merchantName: t.merchantName!,
          disputeReason: t.disputeReason!,
          comment: t.comment || ""
        });

        submitted.push({
          id: itemId,
          caseId: caseId,
          civilId: customer.civilId,
          status: "New",
          cardMasked: masked,
          cardExId: cardExId,
          txnDate: t.txnDate!,
          txnTime: t.txnTime!,
          txnAmount: Number(t.txnAmount),
          merchantName: t.merchantName!,
          disputeReason: t.disputeReason!,
          comment: t.comment || "",
          created: new Date().toISOString()
        });

        if (t.attachment) {
          await this.spSvc.addAttachment(itemId, t.attachment);
        }
      }

      // refresh existing table
      // const allRows = await this.spSvc.getExistingByCivilId(customer.civilId);
      // const currentCaseRows = allRows.filter((r) => r.caseId === this.state.currentCaseId);
      // const previousRows = allRows.filter((r) => r.caseId !== this.state.currentCaseId);

      this.setState({
        submitting: false,
        message: "Transaction(s) added successfully.",
        transactions: [],
        currentCaseRows: [...(this.state.currentCaseRows || []), ...submitted],
        isNewCase: true,
        status: "approved",
        caseItemId: caseItemId
      });
    } catch (e) {
      this.setState({
        submitting: false,
        message: "Submit failed: " + (e && (e as any).message ? (e as any).message : e ? e.toString() : "")
      });
    }
  };
