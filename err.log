import { SPComponentLoader } from '@microsoft/sp-loader';
import * as React from 'react';
import { getSP } from '../common/pnp';
import { sanitizeHtml } from '../common/utils';

// declare const Quill: any;
// declare const DOMPurify: { sanitize: (html: string, opts?: any) => string };

type EditorProps = { context: any; lessonId: number; returnUrl?: string };
type EditorState = { loading: boolean; title?: string; html?: string; error?: string };

require('quill');
require('dompurify');

function waitForQuill(): Promise<void> {
	return new Promise((resolve) => {
		const poll = () => ((window as any).Quill ? resolve() : setTimeout(poll, 10));
		poll();
	});
}

export default class LessonHtmlEditor extends React.Component<EditorProps, EditorState> {
	private hostRef: HTMLDivElement = null as any;

	constructor(p: EditorProps) {
		super(p);
		this.state = { loading: true };
	}

	public async componentDidMount() {
		try {
			const sp = getSP(this.props.context);
			const it = await sp.web.lists.getByTitle('Lessons').items.select('Id', 'Title', 'HtmlContent').filter(`Id eq ${this.props.lessonId}`).top(1)();
			if (!it.length) {
				this.setState({ loading: false, error: 'Lesson not found' });
				return;
			}

			SPComponentLoader.loadCss(`${process.env.BBYN_Public_CDN}/devExtreme/DXQuill/1.3.7/quill.snow.css`);
			await waitForQuill();

			this.setState({ loading: false, title: it[0].Title, html: it[0].HtmlContent }, () => this.initEditor());
		} catch (e) {
			this.setState({ loading: false, error: e && (e as any).message ? (e as any).message : String(e) });
		}
	}

	public componentWillUnmount() {
		const inst: any = $(this.hostRef).dxHtmlEditor('instance');
		if (inst && inst.dispose) inst.dispose();
	}

	public render() {
		if (this.state.loading) return <div>Loadingâ€¦</div>;
		if (this.state.error) return <div style={{ color: 'red' }}>Error: {this.state.error}</div>;

		return (
			<div style={{ padding: 12 }}>
				<h3>Edit Lesson HTML</h3>
				<div style={{ marginBottom: 8, opacity: 0.8 }}>{this.state.title}</div>
				<div ref={(el) => (this.hostRef = el as any)} />
				<div style={{ marginTop: 12 }}>
					<button onClick={this.onSave}>Save & Return</button>
					<button style={{ marginLeft: 8 }} onClick={() => (this.props.returnUrl ? (window.location.href = this.props.returnUrl) : history.back())}>
						Cancel
					</button>
				</div>
			</div>
		);
	}

	private initEditor() {
		if (!(window as any).Quill) {
			console.error('Quill is not loaded - DevExtreme HtmlEditor would throw E1041.');
		}

		$(this.hostRef).dxHtmlEditor({
			value: this.state.html || '',
			height: 480,
			toolbar: {
				items: [
					'undo',
					'redo',
					'separator',
					{ formatName: 'size', formatValues: ['10pt', '12pt', '14pt', '18pt', '24pt'] },
					'bold',
					'italic',
					'underline',
					'strike',
					'separator',
					'alignLeft',
					'alignCenter',
					'alignRight',
					'alignJustify',
					'separator',
					'orderedList',
					'bulletList',
					'separator',
					'link',
					'image',
					'codeBlock',
					'blockquote',
					'separator',
					'clear'
				]
			},
			mediaResizing: { enabled: true }
		});
	}

	private getEditorHtml(): string {
		const inst: any = $(this.hostRef).dxHtmlEditor('instance');
		return inst ? String(inst.option('value') || '') : this.state.html || '';
	}

	private onSave = async () => {
		try {
			const sp = getSP(this.props.context);
			const clean = sanitizeHtml(this.getEditorHtml());
			await sp.web.lists.getByTitle('Lessons').items.getById(this.props.lessonId).update({
				HtmlContent: clean
			});
			// Go back to admin page
			if (this.props.returnUrl) {
				window.location.href = this.props.returnUrl;
			} else if (window.opener) {
				window.opener.postMessage({ type: 'lessonHtmlSaved', id: this.props.lessonId }, '*');
				window.close();
			} else {
				history.back();
			}
		} catch (e) {
			alert('Save failed: ' + (e && (e as any).message ? (e as any).message : String(e)));
		}
	};
}
