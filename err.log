export interface ICaseActionHistory {
  Id: number;
  caseItemId: number;
  caseId?: string;
  taskId?: number;
  taskName?: string;
  action: string;
  comment?: string;
  actionBy?: string;
  actionDate?: string;
}

public async getCaseActionHistory(caseItemId: number): Promise<ICaseActionHistory[]> {

  const url =
    `${this.siteUrl}/_api/web/lists/getbytitle('DisputeCaseActionHistory')/items` +
    `?$select=Id,CaseItemId,CaseId,TaskId,TaskName,Action,Comment,ActionDate,ActionBy/Title` +
    `&$expand=ActionBy` +
    `&$filter=CaseItemId eq ${caseItemId}` +
    `&$orderby=ActionDate desc`;

  const resp = await this.spHttpClient.get(
    url,
    SPHttpClient.configurations.v1
  );

  const json = await resp.json();

  return (json.value || []).map((i: any) => ({
    Id: i.Id,
    caseItemId: i.CaseItemId,
    caseId: i.CaseId,
    taskId: i.TaskId,
    taskName: i.TaskName,
    action: i.Action,
    comment: i.Comment,
    actionDate: i.ActionDate,
    actionBy: i.ActionBy ? i.ActionBy.Title : ""
  }));
}

import * as React from "react";
import { SharePointCaseService } from "../../common";
import { ICaseActionHistory } from "../../models/ICaseActionHistory";

interface IProps {
  caseSvc: SharePointCaseService;
  caseItemId: number;
}

interface IState {
  items: ICaseActionHistory[];
  loading: boolean;
}

export default class CaseActionHistoryPanel extends React.Component<IProps, IState> {

  state: IState = {
    items: [],
    loading: true
  };

  async componentDidMount() {
    await this.load();
  }

  async componentDidUpdate(prev: IProps) {
    if (prev.caseItemId !== this.props.caseItemId) {
      await this.load();
    }
  }

  private async load() {
    this.setState({ loading: true });
    const items = await this.props.caseSvc.getCaseActionHistory(this.props.caseItemId);
    this.setState({ items, loading: false });
  }

  render() {
    const { items, loading } = this.state;

    return (
      <div style={{ marginTop: 24 }}>
        <h4>Task Action History</h4>

        {loading && <div>Loading history...</div>}

        {!loading && items.length === 0 && (
          <div style={{ color: "#777" }}>
            No actions recorded yet.
          </div>
        )}

        {!loading && items.map(h => (
          <div
            key={h.Id}
            style={{
              padding: 10,
              marginBottom: 8,
              borderLeft: "4px solid #0078d4",
              background: "#f8f9fb"
            }}>
            <div style={{ fontWeight: 600 }}>
              {h.action}
            </div>

            <div style={{ fontSize: 12, color: "#555" }}>
              {this.formatDate(h.actionDate)} Â· {h.actionBy}
            </div>

            {h.taskName && (
              <div style={{ fontSize: 12, color: "#777" }}>
                Task: {h.taskName}
              </div>
            )}

            {h.comment && (
              <div style={{ marginTop: 6, whiteSpace: "pre-wrap" }}>
                {h.comment}
              </div>
            )}
          </div>
        ))}
      </div>
    );
  }

  private formatDate(d?: string): string {
    if (!d) return "";
    return new Date(d).toLocaleString("en-GB", {
      day: "2-digit",
      month: "short",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit"
    });
  }
}


{this.state.caseItemId && (
  <CaseActionHistoryPanel
    caseSvc={this.caseSvc}
    caseItemId={this.state.caseItemId}
  />
)}