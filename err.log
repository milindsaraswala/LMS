import * as React from "react";
import { apiGet, apiPost } from "./common/ApiClient";
import CustomerLookup from "./customer/CustomerLookup";
import { ICustomerCard, ICustomerInfo, ICustomerLookupResult } from "./customer/ICustomerInfo";

export type UiStatus = "idle" | "customerFound" | "starting" | "waiting" | "approved" | "rejected" | "failed" | "timeout";

export interface IProps {
  apiBaseUrl: string;
}

export interface IState {
  status: UiStatus;
  customer?: ICustomerInfo;

  message?: string;

  // PACI
  requestId?: string;
  secondsLeft: number;
  resultCode?: number;
  resultDescription?: string;

  cards?: ICustomerCard[];
  selectedCardNo?: string;
  selectedCard?: ICustomerCard;

  txnDate?: string;
  txTime?: string;
  txnAmount?: string;
  merchantName?: string;
  disputeReason?: string;
  comment?: string;
  attachment?: File | null;

  submitting?: boolean;
}

export default class FlowardClaim extends React.Component<IProps, IState> {
  private pollTimer?: number;
  private countdownTimer?: number;

  constructor(props: IProps) {
    super(props);
    this.state = { status: "idle", secondsLeft: 300 };
  }

  public componentWillUnmount(): void {
    this.clearTimers();
  }

  public render(): React.ReactElement<IProps> {
    const { customer, status, message, secondsLeft, requestId } = this.state;

    return (
      <div style={{ padding: 12, maxWidth: 800 }}>
        <CustomerLookup apiBaseUrl={this.props.apiBaseUrl} onCustomerFound={this.onCustomerFound} onCustomerNotFound={this.onCustomerNotFound} />

        {customer && (
          <div style={{ marginTop: 12, border: "1px solid #ddd", padding: 12, borderRadius: 4 }}>
            <div style={{ marginBottom: 8 }}>
              <b>Customer:</b> {customer.fullNameEn} / {customer.fullNameAr}
            </div>

            <button onClick={() => this.startPaciAuth()} disabled={status === "starting" || status === "waiting"} style={{ padding: "8px 14px" }}>
              Authenticate with PACI
            </button>

            {status === "waiting" && (
              <div style={{ marginTop: 10 }}>
                <div>
                  <b>RequestId:</b> {requestId}
                </div>
                <div>
                  <b>Time left:</b> {secondsLeft}s
                </div>
              </div>
            )}

            {message && <div style={{ marginTop: 10 }}>{message}</div>}

            {status === "approved" && this.state.cards && this.state.cards.length > 0 && (
              <div style={{ marginTop: 12, border: "1px solid #ddd", padding: 12, borderRadius: 4 }}>
                <h4 style={{ marginTop: 0 }}>Create Dispute</h4>

                <div style={{ marginBottom: 8 }}>
                  <b>Select Card</b>
                  <select
                    value={this.state.selectedCardNo || ""}
                    onChange={(e) => {
                      const cardNo = (e.target as HTMLSelectElement).value;

                      let picked: ICustomerCard | undefined;
                      const cards = this.state.cards || [];
                      for (let i = 0; i < cards.length; i++) {
                        if (cards[i].cardNo === cardNo) {
                          picked = cards[i];
                          break;
                        }
                      }

                      this.setState({
                        selectedCardNo: cardNo,
                        selectedMaskedCardNo: picked ? picked.maskedCardNo : undefined
                      });
                    }}
                    style={{ padding: 8, minWidth: 320 }}>
                    <option value="">--- Select ----</option>
                    {this.state.cards.map((c) => (
                      <option key={c.cardNo} value={c.cardNo}>
                        {c.maskedCardNo}
                      </option>
                    ))}
                  </select>
                </div>

                {this.state.selectedCardNo && (
                  <div style={{ marginTop: 8, fontSize: 12 }}>
                    <b>Selected:</b>
                    {this.state.selectedMaskedCardNo}
                  </div>
                )}
              </div>
            )}
          </div>
        )}
      </div>
    );
  }

  private clearTimers(): void {
    if (this.pollTimer !== undefined) {
      window.clearInterval(this.pollTimer);
      this.pollTimer = undefined;
    }
    if (this.countdownTimer !== undefined) {
      window.clearInterval(this.countdownTimer);
      this.countdownTimer = undefined;
    }
  }

  private onCustomerFound = (result: ICustomerLookupResult) => {
    this.clearTimers();
    this.setState({
      customer: result.customer,
      cards: result.cards,
      selectedCardNo: undefined,
      status: "customerFound",
      message: undefined,
      requestId: undefined,
      secondsLeft: 300,
      resultCode: undefined,
      resultDescription: undefined
    });
  };

  private onCustomerNotFound = (msg: string) => {
    this.clearTimers();
    this.setState({
      customer: undefined,
      status: "idle",
      message: msg,
      requestId: undefined,
      secondsLeft: 300,
      resultCode: undefined,
      resultDescription: undefined
    });
  };

  private async startPaciAuth(): Promise<void> {
    const customer: ICustomerInfo = this.state.customer;
    if (!customer || !customer.civilId) {
      this.setState({ status: "failed", message: "Please lookup valid Civil ID first." });
      return;
    }

    this.clearTimers();
    this.setState({ status: "starting", message: "Sending PACI authentication request...", secondsLeft: 300 });
    try {
      const url: string = this.props.apiBaseUrl.replace(/\/$/, "") + "/api/paci/initiate-auth";
      const resp = await apiPost<{ requestId: string }>(url, {
        authenticationReasonAr: "الحصول على تفويض العميل لتحديث بيانات البطاقة المدنية",
        authenticationReasonEn: "Get Customer Approval to update Civil Details",
        civilNo: customer.civilId,
        assuranceLevel: "Medium",
        serviceDescriptionEN: "Refund claim for a Gift Card",
        serviceDescriptionAR: "طلب استرداد مبلغ لبطاقة الهدايا",
        additionalData: "",
        challenge: ""
      });
      if (!resp.requestId) {
        this.setState({ status: "failed", message: "No RequestId returned from PACI initiate API." });
        return;
      }
      this.setState({ status: "waiting", requestId: resp.requestId, message: "Waiting for customer approval..." });
      this.startCountdown(resp.requestId);
      this.startPolling(resp.requestId);
    } catch (e) {
      this.setState({ status: "failed", message: e ? e.message : "Failed to initiate PACI auth." });
    }
  }

  private startCountdown(requestId: string) {
    this.countdownTimer = window.setInterval(() => {
      this.setState((prev) => {
        const next = prev.secondsLeft - 1;
        if (next <= 0) {
          this.clearTimers();
          return { ...prev, secondsLeft: 0, status: "timeout", message: "Timed out (5 minutes). No response received." };
        }
        return { ...prev, secondsLeft: next };
      });
    }, 1000);
  }

  private startPolling(requestId: string) {
    this.pollTimer = window.setInterval(async () => {
      try {
        const url = this.props.apiBaseUrl.replace(/\/$/, "") + "/api/paci/status/" + encodeURIComponent(requestId);
        const s = await apiGet<{
          requestId: string;
          isProcessed: boolean;
          resultCode?: number;
          resultDescription?: string;
          userAction?: number;
        }>(url);
        if (!s || !s.isProcessed) {
          return;
        }
        this.clearTimers();
        const rc: number = s.resultCode;
        const desc: string = s.resultDescription;
        if (rc === 10) {
          this.setState({ status: "approved", resultCode: rc, resultDescription: desc, message: desc || "Authenticated" });
        } else if (rc === 40) {
          this.setState({ status: "rejected", resultCode: rc, resultDescription: desc, message: desc || "Declined" });
        } else {
          this.setState({ status: "failed", resultCode: rc, resultDescription: desc, message: desc || "Failed" });
        }
      } catch (err) {
        // solowe
      }
    }, 3000);
  }
}
