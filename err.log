const getWorkstepsByUserKPI = async (contractId: number) => {
  const items = await sp.web.lists
    .getByTitle("Workstep")
    .items
    .select(
      "Id",
      "WorkstepDescription",
      "Percentage",
      "Start",
      "End",
      "UserKPIId"
    )
    .filter(`ContractId eq ${contractId} and isDeleted eq false`)
    .getAll();

  const map: { [key: number]: any[] } = {};
  items.forEach(ws => {
    if (!map[ws.UserKPIId]) {
      map[ws.UserKPIId] = [];
    }
    map[ws.UserKPIId].push(ws);
  });

  return map;
};

const createWorkstepsTable = (worksteps: any[]): Table => {

  const cellWidth = {
    size: 25,
    type: WidthType.PERCENTAGE
  };

  const headerCell = (text: string) =>
    new TableCell({
      width: cellWidth,
      children: [
        new Paragraph({
          text,
          bold: true,
          style: "tableRow"
        })
      ]
    });

  const valueCell = (text: string) =>
    new TableCell({
      width: cellWidth,
      children: [
        new Paragraph({
          text: text || "",
          style: "tableRow"
        })
      ]
    });

  return new Table({
    width: {
      size: 100,
      type: WidthType.PERCENTAGE
    },
    borders: {
      top: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
      bottom: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
      left: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
      right: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
      insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" },
      insideVertical: { style: BorderStyle.SINGLE, size: 1, color: "CCCCCC" }
    },
    rows: [
      // Header row
      new TableRow({
        children: [
          headerCell("Workstep"),
          headerCell("Weight %"),
          headerCell("Start"),
          headerCell("End")
        ]
      }),
      // Data rows
      ...worksteps.map(ws =>
        new TableRow({
          children: [
            valueCell(ws.WorkstepDescription),
            valueCell(ws.Percentage ? `${ws.Percentage}%` : ""),
            valueCell(ws.Start ? `Q${ws.Start}` : ""),
            valueCell(ws.End ? `Q${ws.End}` : "")
          ]
        })
      )
    ]
  });
};

const worksteps = workstepsByKPI[userKPI.Id] || [];

new TableCell({
  margins: {
    right: 300,
    top: 80,
    bottom: 80
  },
  children: [
    // KPI description
    new Paragraph({
      text:
        userKPI.SubCategory === "Financial"
          ? `${userKPI.KPIDescription} (Q${userKPI.Start} - Q${userKPI.End})`
          : userKPI.KPIDescription,
      style: "tableRow"
    }),

    // Financial table (if any)
    ...(userKPI.SubCategory === "Financial"
      ? [
          new Paragraph({}),
          createFinancialSubTable(previousYearTitle, userKPI)
        ]
      : []),

    // Worksteps table (if any)
    ...(worksteps.length > 0
      ? [
          new Paragraph({}), // spacing
          createWorkstepsTable(worksteps)
        ]
      : [])
  ]
})
