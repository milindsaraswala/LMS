using Microsoft.SharePoint;
using System;
using System.Configuration;
using webApi.Models.Floward;

namespace webApi.Services.Floward
{
	public interface IPaciAuthStatusReader
	{
		PaciStatusResponseDto GetStatus(string requestId);
	}
	public class PaciAuthStatusReader : IPaciAuthStatusReader
	{
		private readonly string _siteUrl;
		private readonly string _listName;

		public PaciAuthStatusReader()
		{
			_siteUrl = ConfigurationManager.AppSettings["PaciAuthCallbackLogSiteUrl"];
			_listName = ConfigurationManager.AppSettings["PaciAuthCallbackLogListName"];

			if (string.IsNullOrEmpty(_siteUrl))
				throw new ConfigurationErrorsException("Missing appSettings: PaciAuthCallbackLogSiteUrl");
		}

		public PaciStatusResponseDto GetStatus(string requestId)
		{
			if (string.IsNullOrWhiteSpace(_siteUrl))
				return null;

			PaciStatusResponseDto result = null;

			SPSecurity.RunWithElevatedPrivileges(() =>
			{
				using (var site = new SPSite(_siteUrl))
				using (var web = site.OpenWeb())
				{
					var list = web.Lists[_listName];

					var query = new SPQuery
					{
						RowLimit = 1,
						Query = $@"
											<OrderBy><FieldRef Name='ID' Ascending='FALSE' /></OrderBy>
											<Where>
												<Eq>
													<FieldRef Name='RequestId' />
													<Value Type='Text'>{EscapeCaml(requestId)}</Value>
												</Eq>
											</Where>"
					};

					var items = list.GetItems(query);
					if (items == null || items.Count == 0) return;

					var item = items[0];

					result = new PaciStatusResponseDto
					{
						RequestId = item["RequestId"] as string,
						IsProcessed = ToBool(item["IsProcessed"]),

						ResultCodeRaw = item["ResultCode"]?.ToString(),
						ResultDescription = item["ResultDescription"] as string,
						UserActionRaw = item["UserAction"]?.ToString(),

						ProcessedOn = ToNullableDate(item["ProcessedOn"]),
						ReceivedOn = ToNullableDate(item["Created"]),

						Status = GetStatusText(item)
					};
				}
			});

			return result;
		}
		private static string EscapeCaml(string value)
		{
			return value
					.Replace("&", "&amp;")
					.Replace("<", "&lt;")
					.Replace(">", "&gt;")
					.Replace("\"", "&quot;")
					.Replace("'", "&apos;");
		}
		private static bool ToBool(object v)
		{
			if (v == null) return false;
			if (v is bool b) return b;
			bool.TryParse(v.ToString(), out var r);
			return r;
		}
		private static int? ToNullableInt(object v)
		{
			if (v == null) return null;
			if (v is int i) return i;
			if (int.TryParse(v.ToString(), out var r)) return r;
			return null;
		}
		private static DateTime? ToNullableDate(object v)
		{
			if (v == null) return null;
			if (v is DateTime dt) return dt;
			if (DateTime.TryParse(v.ToString(), out var r)) return r;
			return null;
		}
		private static string GetStatusText(SPListItem item)
		{
			var isProcessed = ToBool(item["IsProcessed"]);
			var code = ToNullableInt(item["ResultCode"]);

			if (!isProcessed)
				return "Pending";

			if (code == 10)
				return "Approved";

			if (code == 40)
				return "Rejected";

			return "Failed";
		}
	}
}
