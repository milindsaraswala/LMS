using Newtonsoft.Json;
using System;
using System.Threading.Tasks;
using System.Web.Http;
using webApi.Models.PACI;
using webApi.Services.Floward;

namespace webApi.Controllers
{
	[RoutePrefix("api/paci")]
	public class PaciCallbackController : ApiController
	{
		private readonly IPaciAuthCallbackLogger _logger;

		public PaciCallbackController()
		{
			_logger = new PaciAuthCallbackLogger();
		}

		[HttpPost]
		[Route("callback/auth")]
		public async Task<IHttpActionResult> CallbackAuth()
		{
			string rawJson = null;
			int logItemId = 0;
			try
			{
				rawJson = await Request.Content.ReadAsStringAsync();

				MIDAuthSignResponseDto data = null;
				try
				{
					var root = JsonConvert.DeserializeObject<PaciCallbackRootDto>(rawJson);
					data = root?.MIDAuthSignResponse;
				}
				catch
				{ }

				if (data == null)
				{
					try
					{
						data = JsonConvert.DeserializeObject<MIDAuthSignResponseDto>(rawJson);
					}
					catch
					{
						_logger.LogReceived(null, rawJson);
						return Ok();
					}
				}
				logItemId = _logger.LogReceived(data, rawJson);

				if (data?.RequestDetails == null ||
					string.IsNullOrWhiteSpace(data.RequestDetails.RequestId))
				{
					_logger.UpdateProcessingResult(
						logItemId,
						false,
						null,
						"Missing RequestDetails or RequestID"
					);

					return Ok();
				}

				int? resultCode = null;

				if (int.TryParse(data.ResultDetails?.ResultCode, out var rc))
				{
					resultCode = rc;
				}

				var userAction = data.ResultDetails?.UserAction;

				_logger.UpdateProcessingResult(logItemId, true, resultCode);
			}
			catch (Exception ex)
			{
				try
				{
					if (logItemId > 0)
					{
						_logger.UpdateProcessingResult(
							logItemId,
							false,
							null,
							ex.Message
						);
					}
					else
					{
						_logger.LogReceived(null, rawJson);
					}
				}
				catch
				{ }
				return Ok();
			}

			return Ok();
		}
	}
}
