using Newtonsoft.Json;
using System;
using System.Configuration;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using webApi.Models.Floward;

namespace webApi.Services.Floward
{
	public class GiftCardGatewayClient : IGiftCardGatewayClient
	{
		private readonly HttpClient _httpClient = new HttpClient();

		private readonly string _baseUrl;
		private readonly string _path;
		private readonly int _clientId;

		public GiftCardGatewayClient()
		{
			var handler = new HttpClientHandler
			{
				ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
			};

			_httpClient = new HttpClient(handler, disposeHandler: true);
			_httpClient.Timeout = TimeSpan.FromSeconds(60);

			_baseUrl = ConfigurationManager.AppSettings["GiftCardApiBaseUrl"].TrimEnd('/');
			_path = ConfigurationManager.AppSettings["GiftCardApiPath"];
			_clientId = int.Parse(ConfigurationManager.AppSettings["ChannelID"]);
		}
		public async Task<GiftCardInquireResponse> InquireAsync(string civilId)
		{
			if (string.IsNullOrEmpty(civilId))
			{
				throw new ArgumentException("civilId is required.", nameof(civilId));
			}

			if (civilId.Length != 12)
			{
				throw new ArgumentException("civilId should be 12 digits only.", nameof(civilId));
			}

			var tracingId = BuildTracingId();

			var requestBody = new GiftCardInquireRequest
			{
				ClientId = _clientId,
				TracingId = tracingId,
				CivilId = civilId
			};

			var accessToken = await GiftCardOAuthTokenProvider.GetAccessTokenAsync().ConfigureAwait(false);

			var url = _baseUrl + _path;
			var json = JsonConvert.SerializeObject(requestBody);
			var content = new StringContent(json, Encoding.UTF8, "application/json");

			var httpRequest = new HttpRequestMessage(HttpMethod.Post, url);
			httpRequest.Content = content;
			httpRequest.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", accessToken);

			var response = await _httpClient.SendAsync(httpRequest).ConfigureAwait(false);

			var responseJson = await response.Content.ReadAsStringAsync().ConfigureAwait(false);
			if (!response.IsSuccessStatusCode)
			{
				throw new Exception($"GW returned {(int)response.StatusCode}: {responseJson}");
			}

			var result = JsonConvert.DeserializeObject<GiftCardInquireResponse>(responseJson);
			return result;
		}

		private string BuildTracingId()
		{
			var ts = DateTime.Now.ToString("yyyyMMdd-HHmmss.fff");
			return $"{_clientId}-${ts}";
		}
	}
}
