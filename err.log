using Microsoft.SharePoint;
using System;
using System.Configuration;
using System.Linq;
using System.Web.Http;
using webApi.Models.PACI;

namespace webApi.Controllers
{
    [RoutePrefix("api/paci")]
    public class PaciAuthController : ApiController
    {
        // ... your existing code (initiate-auth, ping, etc.)

        [HttpGet]
        [Route("status/{requestId}")]
        public IHttpActionResult GetStatus(string requestId)
        {
            if (string.IsNullOrWhiteSpace(requestId))
                return BadRequest("requestId is required");

            var siteUrl = ConfigurationManager.AppSettings["PaciAuthCallbackLogSiteUrl"];
            var listName = ConfigurationManager.AppSettings["PaciAuthCallbackLogListName"];

            if (string.IsNullOrWhiteSpace(siteUrl))
                return InternalServerError(new ConfigurationErrorsException("Missing appSettings: PaciAuthCallbackLogSiteUrl"));

            if (string.IsNullOrWhiteSpace(listName))
                listName = "PaciAuthCallbackLog";

            PaciAuthStatusDto dto = null;

            SPSecurity.RunWithElevatedPrivileges(() =>
            {
                using (var site = new SPSite(siteUrl))
                using (var web = site.OpenWeb())
                {
                    var list = web.Lists[listName];

                    var query = new SPQuery
                    {
                        RowLimit = 1,
                        Query = $@"
<OrderBy><FieldRef Name='ID' Ascending='FALSE' /></OrderBy>
<Where>
  <Eq>
    <FieldRef Name='RequestId' />
    <Value Type='Text'>{EscapeCaml(requestId)}</Value>
  </Eq>
</Where>"
                    };

                    var items = list.GetItems(query);
                    if (items == null || items.Count == 0)
                    {
                        dto = new PaciAuthStatusDto
                        {
                            RequestId = requestId,
                            IsProcessed = false
                        };
                        return;
                    }

                    var item = items[0];

                    // Note: your list uses these internal names (based on your logger):
                    // RequestId, IsProcessed, ResultCode, ResultDescription, UserAction, ProcessedOn, Created
                    dto = new PaciAuthStatusDto
                    {
                        RequestId = item["RequestId"] as string,
                        IsProcessed = ToBool(item["IsProcessed"]),
                        ResultCode = ToNullableInt(item["ResultCode"]),
                        ResultDescription = item["ResultDescription"] as string,
                        UserAction = ToNullableInt(item["UserAction"]),
                        ProcessedOn = ToNullableDate(item["ProcessedOn"]),
                        CallbackReceivedOn = ToNullableDate(item["Created"]) // SharePoint item created time
                    };
                }
            });

            return Ok(dto);
        }

        private static bool ToBool(object v)
        {
            if (v == null) return false;
            if (v is bool b) return b;
            bool.TryParse(v.ToString(), out var r);
            return r;
        }

        private static int? ToNullableInt(object v)
        {
            if (v == null) return null;
            if (v is int i) return i;
            if (int.TryParse(v.ToString(), out var r)) return r;
            return null;
        }

        private static DateTime? ToNullableDate(object v)
        {
            if (v == null) return null;
            if (v is DateTime dt) return dt;
            if (DateTime.TryParse(v.ToString(), out var r)) return r;
            return null;
        }

        private static string EscapeCaml(string value)
        {
            return value
                .Replace("&", "&amp;")
                .Replace("<", "&lt;")
                .Replace(">", "&gt;")
                .Replace("\"", "&quot;")
                .Replace("'", "&apos;");
        }
    }
}