import * as React from "react";
import { validateCivilId } from "./CustomerValidation";
import { ICustomerCard, ICustomerInfo, ICustomerLookupResult, IFlowardCard, IFlowardCustomerResponse } from "./ICustomerInfo";

export interface IProps {
  apiBaseUrl: string;
  onCustomerFound: (customer: ICustomerLookupResult) => void;
  onCustomerNotFound: (message: string) => void;
}

export interface IState {
  civilId: string;
  loading: boolean;
  message?: string;
  customer?: ICustomerInfo;
  cards?: ICustomerCard[];
}

export default class CustomerLookup extends React.Component<IProps, IState> {
  constructor(props: IProps) {
    super(props);
    this.state = {
      civilId: "",
      loading: false
    };
  }

  public render(): React.ReactElement<IProps> {
    const { customer, loading, message } = this.state;

    return (
      <div style={{ padding: 12, maxWidth: 700 }}>
        <h3 style={{ marginTop: 0 }}>Customer Lookup</h3>

        <div style={{ display: "flex", gap: 8, marginBottom: 10 }}>
          <input
            type="text"
            value={this.state.civilId}
            maxLength={12}
            onChange={(e) => {
              const v: string = (e.target as HTMLInputElement).value;
              if (/^\d*$/.test(v)) {
                this.setState({ civilId: v });
              }
            }}
            placeholder="Enter Civil ID"
            style={{ flex: 1, padding: 8, border: "1px inset #767676", backgroundColor: "field", backgroundImage: "initial" }}
            disabled={loading}
          />
          <button onClick={() => this.lookup()} disabled={loading} style={{ padding: "8px 14px" }}>
            {loading ? "Searching..." : "Search"}
          </button>
        </div>

        {message && <div style={{ marginBottom: 10 }}>{message}</div>}

        {customer && (
          <div style={{ border: "1px solid #ddd", padding: 12, borderRadius: 4 }}>
            <div>
              <b>Civil ID : </b>
              {customer.civilId}
            </div>
            <div>
              <b>Name AR : </b>
              {customer.fullNameAr}
            </div>
            <div>
              <b>Name EN : </b>
              {customer.fullNameEn}
            </div>
            <div>
              <b>Nationality : </b>
              {customer.nationality}
            </div>
            <div>
              <b>DOB : </b>
              {customer.dob}
            </div>
            <div>
              <b>Mobile : </b>
              {customer.mobile}
            </div>
          </div>
        )}
      </div>
    );
  }

  private async lookup(): Promise<void> {
    const civilId: string = (this.state.civilId || "").trim();

    const validationError: string | null = validateCivilId(civilId);
    if (validationError) {
      this.setState({ message: validationError, customer: undefined, loading: false });
      this.props.onCustomerNotFound(validationError);
      return;
    }

    if (!this.props.apiBaseUrl) {
      const msg: string = "API Base URL is not configured.";
      this.setState({ message: msg, customer: undefined, loading: false });
      this.props.onCustomerNotFound(msg);
      return;
    }

    this.setState({ loading: true, message: undefined, customer: undefined });

    try {
      const url: string = this.props.apiBaseUrl.replace(/\/$/, "") + "/api/floward/" + encodeURIComponent(civilId);

      const resp: Response = await fetch(url, { method: "GET", headers: { Accept: "application/json" } });

      if (resp.status === 404) {
        const txt: string = await resp.text();
        const msg: string = txt && txt.trim() ? txt : "Customer not found.";
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      if (!resp.ok) {
        const txt: string = await resp.text();
        const msg: string = "Error calling API: " + txt;
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      const api: IFlowardCustomerResponse = (await resp.json()) as IFlowardCustomerResponse;

      if (!api) {
        const msg: string = "Empty response from API.";
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      if (!api.cards || api.cards.length === 0) {
        const msg: string = "Customer not found.";
        this.setState({ loading: false, message: msg, customer: undefined });
        this.props.onCustomerNotFound(msg);
        return;
      }

      // const cards: ICustomerCard[] = api.cards.map((x) => ({
      //   cardNo: x.cardNo || x.maskedCardNo,
      //   maskedCardNo: this.maskCardNumber(x.cardNo || x.maskedCardNo),
      //   cardExpire: x.cardExpire
      // }));

      const first: IFlowardCard = api.cards[0];

      const customer: ICustomerInfo = {
        civilId: first.civilId,
        fullNameAr: first.cardholderNameAr,
        fullNameEn: first.cardholderNameEn,
        nationality: first.nationality,
        dob: first.dateOfBirth,
        mobile: first.cardholderMobile
        // cards: (api.cards || []).map((c) => ({
        //   cardExpire: c.cardExpire,
        //   maskedCardNo: this.maskCardNumber(c.maskedCardNo || c.cardNo),
        //   cardNo: c.cardNo,
        //   cardExid: c.cardExid
        // }))
      };

      const cards: ICustomerCard[] = api.cards.map((c) => {
        const fullCardNo = c.cardNo || c.maskedCardNo;

        return {
          cardNo: fullCardNo,
          maskedCardNo: this.maskCardNumber(fullCardNo),
          cardExpire: c.cardExpire,
          cardExid: c.cardExid
        };
      });

      this.setState({ loading: false, customer: customer, cards, message: undefined });

      this.props.onCustomerFound({ customer, cards });
    } catch (e) {
      const msg: string = e && (e as any).message ? (e as any).message : "Unexpected error.";
      this.setState({
        loading: false,
        message: msg
      });
      this.props.onCustomerNotFound(msg);
    }
  }

  private maskCardNumber = (cardNo: string): string => {
    if (!cardNo || cardNo.length < 8) {
      return cardNo;
    }

    const first4: string = cardNo.substring(0, 4);
    const last4: string = cardNo.substring(cardNo.length - 4);

    const middleLen: number = cardNo.length - 8;
    const middle: string = new Array(middleLen + 1).join("*");

    return first4 + middle + last4;
  };
}
