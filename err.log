using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.Configuration;
using System.Net.Http;
using System.Threading.Tasks;

namespace webApi.Services.Floward
{
	public class OAuthTokenResponse
	{
		[JsonProperty("access_token")]
		public string AccessToken { get; set; }

		[JsonProperty("token_type")]
		public string TokenType { get; set; }

		[JsonProperty("expires_in")]
		public int ExpiresIn { get; set; }
	}

	public class GiftCardOAuthTokenProvider
	{
		private static readonly object _lock = new object();
		private static string _accessToken;
		private static DateTime _expiresAtUtc;

		public static async Task<string> GetAccessTokenAsync()
		{
			lock (_lock)
			{
				if(!string.IsNullOrEmpty(_accessToken) && DateTime.UtcNow < _expiresAtUtc)
				{
					return _accessToken;
				}
			}

			var tokenUrl = ConfigurationManager.AppSettings["FlowardOAuthTokenUrl"];
			var clientId = ConfigurationManager.AppSettings["FlowardOAuthClientId"];
			var clientSecret = ConfigurationManager.AppSettings["FlowardOAuthClientSecret"];
			var scope = ConfigurationManager.AppSettings["FlowardOAuthScope"];
			var username = ConfigurationManager.AppSettings["FlowardOAuthUsername"];
			var password = ConfigurationManager.AppSettings["FlowardOAuthPassword"];
			bool isUAT = Convert.ToBoolean(ConfigurationManager.AppSettings["isUAT"]);

			using (var client = new HttpClient())
			{
				if (isUAT)
				{
					var form = new FormUrlEncodedContent(new[]
					{
					new KeyValuePair<string,string>("grant_type","password"),
					new KeyValuePair<string,string>("username",username),
					new KeyValuePair<string,string>("password",password),

					new KeyValuePair<string,string>("client_id",clientId),
					new KeyValuePair<string,string>("client_secret",clientSecret)
				});
				}
				else
				{
					var form = new FormUrlEncodedContent(new[]
					{
					new KeyValuePair<string,string>("grant_type","password"),
					new KeyValuePair<string,string>("username",username),
					new KeyValuePair<string,string>("password",password),

					new KeyValuePair<string,string>("client_id",clientId),
					new KeyValuePair<string,string>("client_secret",clientSecret),
					new KeyValuePair<string,string>("scope",scope),
				});
				}

				var response = await client.PostAsync(tokenUrl, form).ConfigureAwait(false);
				var json = await response.Content.ReadAsStringAsync();

				response.EnsureSuccessStatusCode();

				var token = JsonConvert.DeserializeObject<OAuthTokenResponse>(json);

				lock (_lock)
				{
					_accessToken = token.AccessToken;
					_expiresAtUtc = DateTime.UtcNow.AddSeconds(token.ExpiresIn - 60);
				}

				return _accessToken;
			}
		}
	}
}
