using Microsoft.Web.Services3.Security.Tokens;
using System;
using System.Configuration;
using System.Net;
using System.Net.Http;
using System.Net.Security;
using System.Threading.Tasks;
using webApi.Models.PACI;

namespace webApi.Models.Floward
{
	public interface IPaciSoapClient
	{
		Task<PaciInitiateAuthResponseDto> InitiateAuthAsync(PaciInitiateAuthRequestDto request, string callbackUrl);
	}
	public class PaciSoapClient : IPaciSoapClient
	{
		private readonly string _serviceUrl;
		private readonly string _username;
		private readonly string _password;

		public PaciSoapClient()
		{
			_serviceUrl = ConfigurationManager.AppSettings["PaciSoapServiceUrl"];
			_username = ConfigurationManager.AppSettings["CoreRESTClientId"];
			_password = ConfigurationManager.AppSettings["CoreRESTSecretKey"];		
		}

		public async Task<PaciInitiateAuthResponseDto> InitiateAuthAsync(PaciInitiateAuthRequestDto request, string callbackUrl)
		{
			return await Task.Run(() =>
			{
				var authRequest = new MobileIDAuth.AuthenticateRequest
				{
					ServiceDescriptionEN = request.ServiceDescriptionEN,
					ServiceDescriptionAR = request.ServiceDescriptionAR,
					AdditionalData = request.AdditionalData ?? string.Empty,
					Challenge = request.Challenge ?? string.Empty,
					SPCallbackURL = callbackUrl,
					PersonCivilNo = request.CivilNo
				};

				var client = new Services.MidWrapperServiceWithBasicAuth
				{
					Url = _serviceUrl,
					BasicUser = _username,
					BasicPass = _password,
					PreAuthenticate = true,
					Timeout = 1000 * 60 * 2
				};

				bool assuranceSpecified = true;

				var response = client.InitiateAuthRequestPNWithAssuranceLevel(
					authRequest,
					MobileIDAuth.MIDAssuranceLevel.Medium,
					assuranceSpecified
					);

				if (response.Error != null)
				{
					throw new ApplicationException($"PACI error {response.Error.Code}: {response.Error.Message}");
				}

				var requestId = response.Data;

				return new PaciInitiateAuthResponseDto
				{
					RequestId = requestId
				};
			});
		}
	}
}
