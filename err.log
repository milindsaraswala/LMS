import * as React from "react";
import NintexWorkflowService, { INintexTask } from "../../common/NintexWorkflowService";

export interface IWorkflowActionPanelProps {
  nintexSvc: NintexWorkflowService;
  listName: string;
  itemId: number;
  onActionCompleted: () => void; // refresh parent
}

export interface IWorkflowActionPanelState {
  loading: boolean;
  tasks: INintexTask[];
  error?: string;
  comment: string;
  submittingTaskId?: number;
}

export default class WorkflowActionPanel extends React.Component<
  IWorkflowActionPanelProps,
  IWorkflowActionPanelState
> {
  constructor(props: IWorkflowActionPanelProps) {
    super(props);

    this.state = {
      loading: true,
      tasks: [],
      comment: ""
    };
  }

  public componentDidMount(): void {
    this.loadTasks();
  }

  private async loadTasks(): Promise<void> {
    this.setState({ loading: true, error: undefined });

    try {
      const tasks = await this.props.nintexSvc.getRunningTasksForItem(
        this.props.listName,
        this.props.itemId
      );

      this.setState({ tasks, loading: false });
    } catch (e) {
      this.setState({
        loading: false,
        error: "Failed to load workflow tasks"
      });
    }
  }

  private async executeAction(
    task: INintexTask,
    outcome: string
  ): Promise<void> {
    if (!this.state.comment) {
      alert("Please enter comment");
      return;
    }

    this.setState({ submittingTaskId: task.sharePointTaskId });

    try {
      await this.props.nintexSvc.completeTask(
        task.sharePointTaskId,
        outcome,
        this.state.comment
      );

      alert(`Action "${outcome}" completed`);

      this.setState({
        comment: "",
        submittingTaskId: undefined
      });

      // refresh tasks + parent UI
      await this.loadTasks();
      this.props.onActionCompleted();

    } catch (e) {
      alert("Workflow action failed");
      this.setState({ submittingTaskId: undefined });
    }
  }

  private renderButtons(task: INintexTask): React.ReactElement {
    const disabled = this.state.submittingTaskId === task.sharePointTaskId;

    switch (task.taskType) {
      case "Approval":
      case "MultiOutcome":
        return (
          <>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Approve")}>
              Approve
            </button>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Reject")}>
              Reject
            </button>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Hold")}>
              Hold
            </button>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Amend")}>
              Send Back
            </button>
          </>
        );

      case "Review":
        return (
          <>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Complete")}>
              Complete
            </button>
            <button disabled={disabled} onClick={() => this.executeAction(task, "Reopen")}>
              Reopen
            </button>
          </>
        );

      default:
        return <span>No actions available</span>;
    }
  }

  public render(): React.ReactElement<any> {
    const { loading, tasks, error } = this.state;

    if (loading) {
      return <div>Loading workflow actions...</div>;
    }

    if (error) {
      return <div style={{ color: "#b00020" }}>{error}</div>;
    }

    if (!tasks || tasks.length === 0) {
      return <div>No pending workflow actions.</div>;
    }

    return (
      <div style={panelStyle}>
        <h4>Workflow Actions</h4>

        <textarea
          placeholder="Enter comment (mandatory)"
          value={this.state.comment}
          onChange={(e) => this.setState({ comment: e.currentTarget.value })}
          style={commentBox}
        />

        {tasks.map((task) => (
          <div key={task.sharePointTaskId} style={taskRow}>
            <div style={{ fontWeight: 600 }}>
              {task.taskName} ({task.workflowName})
            </div>

            <div style={buttonRow}>
              {this.renderButtons(task)}
            </div>
          </div>
        ))}
      </div>
    );
  }
}

/* -------------------- styles -------------------- */

const panelStyle: React.CSSProperties = {
  marginTop: 20,
  padding: 12,
  border: "1px solid #ddd",
  borderRadius: 4,
  background: "#fafafa"
};

const commentBox: React.CSSProperties = {
  width: "100%",
  minHeight: 60,
  padding: 8,
  marginBottom: 12
};

const taskRow: React.CSSProperties = {
  borderTop: "1px solid #eee",
  paddingTop: 10,
  marginTop: 10
};

const buttonRow: React.CSSProperties = {
  marginTop: 6,
  display: "flex",
  gap: 8
};