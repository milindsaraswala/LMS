using Newtonsoft.Json;
using System;
using System.Configuration;
using System.Net.Http;
using System.Text;
using System.Threading.Tasks;
using webApi.Models.Floward;

namespace webApi.Services.Floward
{
	public class GiftCardGatewayClient : IGiftCardGatewayClient
	{
		private readonly HttpClient _httpClient = new HttpClient();

		private readonly string _baseUrl;
		
		public GiftCardGatewayClient()
		{
			var handler = new HttpClientHandler
			{
				ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
			};

			_httpClient = new HttpClient(handler, disposeHandler: true);
			_httpClient.Timeout = TimeSpan.FromSeconds(60);

			_baseUrl = ConfigurationManager.AppSettings["GiftCardApiBaseUrl"].TrimEnd('/');
		}
		public async Task<TResp>PostAsync<TReq,TResp>(string path,TReq body)
		{
			if (string.IsNullOrEmpty(_baseUrl))
				throw new ConfigurationErrorsException("Missing appSettings: GiftCardApiBaseUrl");

			var url = _baseUrl + "/" + (path ?? "").TrimStart('/');

			var accessToken = await GiftCardOAuthTokenProvider.GetAccessTokenAsync().ConfigureAwait(false);

			var json = JsonConvert.SerializeObject(body);
			var content = new StringContent(json, Encoding.UTF8, "application/json");

			var httpRequest = new HttpRequestMessage(HttpMethod.Post, url);
			httpRequest.Content = content;
			httpRequest.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", accessToken);

			var response = await _httpClient.SendAsync(httpRequest).ConfigureAwait(false);
			var responseJson = await response.Content.ReadAsStringAsync().ConfigureAwait(false);
			if (!response.IsSuccessStatusCode)
				throw new Exception($"GW returned {(int)response.StatusCode}: {responseJson}");

			return JsonConvert.DeserializeObject<TResp>(responseJson);
		}
	}
}
