import { WebPartContext } from "@microsoft/sp-webpart-base";

export interface INintexTask {
  sharePointTaskId: number;
  taskName: string;
  taskType: string;
  taskListName: string;
}

export interface INintexOutcome {
  id: number;
  name: string;
  commentMode: "None" | "Optional" | "Required";
}

export default class NintexWorkflowService {
  private context: WebPartContext;
  private siteUrl: string;

  constructor(context: WebPartContext) {
    this.context = context;
    this.siteUrl = context.pageContext.web.absoluteUrl;
  }

  // -------------------------------
  // 1. Get running task
  // -------------------------------
  public async getRunningTask(
    listName: string,
    itemId: number
  ): Promise<INintexTask | null> {

    var soapBody =
      '<?xml version="1.0" encoding="utf-8"?>' +
      '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
      'xmlns:xsd="http://www.w3.org/2001/XMLSchema" ' +
      'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
      '<soap:Body>' +
      '<GetRunningWorkflowTasksForCurrentUserForListItem xmlns="http://nintex.com">' +
      '<itemId>' + itemId + '</itemId>' +
      '<listName>' + listName + '</listName>' +
      '</GetRunningWorkflowTasksForCurrentUserForListItem>' +
      '</soap:Body>' +
      '</soap:Envelope>';

    var response = await fetch(
      this.siteUrl + "/_vti_bin/NintexWorkflow/workflow.asmx",
      {
        method: "POST",
        headers: {
          "Content-Type": "text/xml; charset=utf-8",
          "SOAPAction":
            "http://nintex.com/GetRunningWorkflowTasksForCurrentUserForListItem"
        },
        body: soapBody,
        credentials: "same-origin"
      }
    );

    var text = await response.text();
    var xml = new DOMParser().parseFromString(text, "text/xml");

    var taskNodes = xml.getElementsByTagName("UserTask");
    if (!taskNodes || taskNodes.length === 0) {
      return null;
    }

    var task = taskNodes[0];

    return {
      sharePointTaskId: parseInt(
        task.getElementsByTagName("SharePointTaskId")[0].textContent,
        10
      ),
      taskName: task.getElementsByTagName("TaskName")[0].textContent,
      taskType: task.getElementsByTagName("TaskType")[0].textContent,
      taskListName: "Workflow Tasks"
    };
  }

  // -------------------------------
  // 2. Get FlexiTask outcomes
  // -------------------------------
  public async getFlexiTaskOutcomes(
    taskId: number,
    taskListName: string
  ): Promise<INintexOutcome[]> {

    var soapBody =
      '<?xml version="1.0" encoding="utf-8"?>' +
      '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
      'xmlns:xsd="http://www.w3.org/2001/XMLSchema" ' +
      'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
      '<soap:Body>' +
      '<GetOutcomesForFlexiTask xmlns="http://nintex.com">' +
      '<spTaskId>' + taskId + '</spTaskId>' +
      '<taskListName>' + taskListName + '</taskListName>' +
      '</GetOutcomesForFlexiTask>' +
      '</soap:Body>' +
      '</soap:Envelope>';

    var response = await fetch(
      this.siteUrl + "/_vti_bin/NintexWorkflow/workflow.asmx",
      {
        method: "POST",
        headers: {
          "Content-Type": "text/xml; charset=utf-8",
          "SOAPAction": "http://nintex.com/GetOutcomesForFlexiTask"
        },
        body: soapBody,
        credentials: "same-origin"
      }
    );

    var text = await response.text();
    var xml = new DOMParser().parseFromString(text, "text/xml");

    var outcomeNodes = xml.getElementsByTagName("ConfiguredOutcome");
    var results: INintexOutcome[] = [];

    for (var i = 0; i < outcomeNodes.length; i++) {
      var n = outcomeNodes[i];

      results.push({
        id: parseInt(n.getAttribute("Id"), 10),
        name: n.getAttribute("Name"),
        commentMode: n.getAttribute("CommentMode") as any
      });
    }

    return results;
  }

  // -------------------------------
  // 3. Complete FlexiTask
  // -------------------------------
  public async completeFlexiTask(
    taskId: number,
    outcome: string,
    comment: string
  ): Promise<void> {

    var soapBody =
      '<?xml version="1.0" encoding="utf-8"?>' +
      '<soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" ' +
      'xmlns:xsd="http://www.w3.org/2001/XMLSchema" ' +
      'xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">' +
      '<soap:Body>' +
      '<CompleteFlexiTask xmlns="http://nintex.com">' +
      '<spTaskId>' + taskId + '</spTaskId>' +
      '<outcome>' + outcome + '</outcome>' +
      '<comment>' + (comment || "") + '</comment>' +
      '</CompleteFlexiTask>' +
      '</soap:Body>' +
      '</soap:Envelope>';

    await fetch(
      this.siteUrl + "/_vti_bin/NintexWorkflow/workflow.asmx",
      {
        method: "POST",
        headers: {
          "Content-Type": "text/xml; charset=utf-8",
          "SOAPAction": "http://nintex.com/CompleteFlexiTask"
        },
        body: soapBody,
        credentials: "same-origin"
      }
    );
  }
}