//============ Controller
using System;
using System.Configuration;
using System.Net;
using System.Threading.Tasks;
using System.Web.Http;
using webApi.Models.Floward;
using webApi.Services.Floward;

namespace webApi.Controllers
{
	[RoutePrefix("api/floward")]
	public class FlowardController : ApiController
	{
		private readonly IGiftCardGatewayClient _client;

		public FlowardController()
		{
			_client = new GiftCardGatewayClient();
		}

		#region Gift Card Details - Rest : Calling api/floward/{param}
		[HttpGet]
		[Route("{civilId}")]
		public async Task<IHttpActionResult> GetGiftCardDetailsByCivilID(GiftCardInquireRequest req)
		{
			if (req == null) return BadRequest("Body is required");
			if (string.IsNullOrWhiteSpace(req.TracingId)) return BadRequest("tracingId is required");
			if (req.ClientId <= 0) return BadRequest("clientId must be > 0");
			if (string.IsNullOrEmpty(req.CivilId)) return BadRequest("CivilId is required.");
			if (req.CivilId.Length != 12) return BadRequest("civilId should be 12 digits only.");

			for (int i = 0; i < req.CivilId.Length; i++)
			{
				if (!char.IsDigit(req.CivilId[i])) return BadRequest("civilId should contain digits only.");
			}

			var path = ConfigurationManager.AppSettings["GiftCardApiPath"] ?? "/cms/giftcard/inquire";

			try
			{
				var result = await _client.PostAsync<GiftCardInquireRequest,GiftCardInquireResponse>(path,req).ConfigureAwait(false);

				if (result == null)
					return Content(HttpStatusCode.BadGateway, "Empty Response from GW");

				return Ok(result);
			}
			catch (ArgumentException ex)
			{
				return Content(HttpStatusCode.BadRequest, new { message = ex.Message });
			}
			catch (Exception ex)
			{
				return Content(HttpStatusCode.BadGateway, new { message = "Error while calling gift card API", detail = ex.ToString() });
			}
		}
		//public async Task<IHttpActionResult>GetGiftCardDetailsByCivilID(string civilid)
		//{

		//	try
		//	{
		//		var result = await _client.InquireAsync(civilid).ConfigureAwait(false);

		//		if (result == null)
		//			return Content(HttpStatusCode.BadGateway, "Empty Response from GW");

		//		return Ok(result);
		//	}
		//	catch(ArgumentException ex)
		//	{
		//		return Content(HttpStatusCode.BadRequest, new { message = ex.Message });
		//	}
		//	catch(Exception ex)
		//	{
		//		return Content(HttpStatusCode.BadGateway, new { message = "Error while calling gift card API", detail = ex.ToString() });
		//	}
		//}
		#endregion

		#region Gift Card Full Refund - Rest : Calling api/floward/refund/full
		[HttpPost]
		[Route("refund/full")]
		public async Task<IHttpActionResult> FullRefund(GiftCardRefundRequest req)
		{
			if (req == null) return BadRequest("Body is required");
			if (string.IsNullOrWhiteSpace(req.tracingId)) return BadRequest("tracingId is required");
			if (req.clientId <= 0) return BadRequest("clientId must be > 0");
			if (string.IsNullOrWhiteSpace(req.cardExid)) return BadRequest("CardExid is required");
			if (string.IsNullOrWhiteSpace(req.userId)) return BadRequest("userId is required");

			var path = ConfigurationManager.AppSettings["GiftCardRefundPath"] ?? "/cms/giftcard/initiateRefund";

			try
			{
				var resp = await _client.PostAsync<GiftCardRefundRequest, GiftCardRefundResponse>(path, req);

				return Ok(resp);
			}
			catch (Exception ex)
			{
				return Content(HttpStatusCode.BadGateway, new
				{
					message = "Error while calling Gift Refund API",
					detail = ex.ToString()
				});
			}
		}
		#endregion
	}
}
